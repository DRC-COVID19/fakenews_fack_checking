<% extend('../../layout/layout') %>
<div class="container">
  <div class="content mt-5">
    <div class="row justify-content-center">
      <div class="col-sm-8">
        <h1>
          Avez-vous vu ou entendu des informations erronées sur le coronavirus ?
          Dites-nous tout
        </h1>
        <div class="form-description">
          <p>
            Nous comptons sur votre active participation pour avoir des
            informations sur lesquelles effectuer le fact checking
            (vérifications des faits).
          </p>
          <hr />
          <p>
            Soyez aussi concis et précis que possible. Incluez des liens ou des
            captures d'écran si vous en avez. Cela aide nos vérificateurs à
            travailler plus rapidement.
          </p>
        </div>
        <p id="err" style="color: red;"></p>
        <div class="content-card main-card">
          <div class="body">
            <form
              id="request_factcheck"
              class=""
              action="/api/news/"
              method="post"
              enctype="multipart/form-data"
            >
              <div class="row">
                <div class="col-12">
                  <label for="description">
                    <p class="label-title">
                      Quelle question, préoccupation ou expérience
                      souhaitez-vous partager à propos de COVID-19 ou du
                      coronavirus?
                    </p>
                    <p class="label-description">
                      Avec vos propres mots, partagez toutes les rumeurs,
                      «conseils» ou histoires personnelles que vous avez
                      rencontrées et que STOPCORONAVIRUS devrait enquêter.
                    </p>
                  </label>
                  <textarea
                    class="form-control"
                    id="description"
                    name="description"
                    rows="3"
                    required
                  ></textarea>
                </div>
                <div class="col-12">
                  <label for="sources">
                    <p class="label-title">
                      Vous avez un lien vers un exemple ou d'autres informations
                      qui aideront nos vérificateurs de faits ?
                    </p>
                    <p class="label-description">
                      Ceci est facultatif, mais vraiment utile. Veuillez s'il
                      vous plaît renseigner un lien par ligne.
                    </p>
                  </label>
                  <textarea
                    class="form-control"
                    id="sources"
                    name="sources"
                    rows="3"
                  ></textarea>
                </div>
                <div class="col-12">
                  <div class="position-relative">
                    <label for="media">
                      <p class="label-title">
                        Vous avez une capture d'écran ?
                      </p>
                      <p class="label-description">
                        Ce champs est optionel
                      </p>
                    </label>
                    <input
                      id="media"
                      class="form-control"
                      type="text"
                      name="media"
                      value=""
                    />
                  </div>
                </div>
                <div class="col-12">
                  <label for="email">
                    <p class="label-title">
                      STOPCORONAVIRUS peut-il vous joindre ?
                    </p>
                    <p class="label-description">
                      Si oui, laissez-nous votre email. Ceci est facultatif
                    </p>
                  </label>
                  <input
                    id="email"
                    class="form-control"
                    type="text"
                    name="email"
                    value=""
                  />
                </div>
                <div class="col-12">
                  <label for="fullName">
                    <p class="label-title">Laissez-nous votre nom</p>
                    <p class="label-description">
                      Optionnel. Ceci nous permettrait de personnaliser toute
                      correspondance future en avec votre nom.
                    </p>
                  </label>
                  <input
                    id="fullName"
                    class="form-control"
                    type="text"
                    name="fullName"
                    value=""
                  />
                </div>
                <div class="col-12">
                  <label for="location">
                    <p class="label-title">Votre emplacement</p>
                    <p class="label-description">Pays, Ville ou Commune</p>
                  </label>
                  <input
                    id="location"
                    class="form-control"
                    type="text"
                    name="location"
                    required
                    value=""
                  />
                </div>
              </div>
              <div class="row">
                <div class="col-12">
                  <input
                    type="submit"
                    class="btn btn-dark"
                    name=""
                    value="Envoyer"
                  />
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
  <script type="text/javascript">  
    const cloudinaryWidget = cloudinary.createUploadWidget({
      cloudName: 'kinshasa-digital', 
      uploadPreset: 'news_uploads',
      maxFileSize: 1500000,
      clientAllowedFormats: ["png","gif", "jpeg"],
      multiple: false,
      styles: {
        palette: {
            link: "#343A40",
        },
      },
      language: "fr",
      text: {
        "fr": { // https://widget.cloudinary.com/v2.0/global/text.json
          "or": "Ou",
          "back": "Retour",
          "advanced": "Avancé",
          "close": "Fermer",
          "no_results": "Aucun résultat",
          "search_placeholder": "Rechercher des fichiers",
          "about_uw": "À propos du widget de téléchargement",
          "menu": {
            "files": "Mes Fichiers",
            "web": "Adresse web",
            "camera": "Caméra",
            "gsearch": "Recherche d'image",
            "gdrive": "Google Drive",
            "dropbox": "Dropbox",
            "facebook": "Facebook",
            "instagram": "Instagram",
            "shutterstock": "Shutterstock"
          },
          "local": {
            "browse": "Parcourir",
            "main_title": "Télécharger des fichiers",
            "dd_title_single": "Glissez-déposez un élément ici",
            "dd_title_multi": "Glissez et déposez les ressources ici",
            "drop_title_single": "Déposer un fichier à télécharger",
            "drop_title_multiple": "Déposer les fichiers à télécharger"
           },
          "queue": {
            "title": "File d'attente",
            "title_uploading_with_counter": "Téléchargement de {{num}} fichiers",
            "title_uploading": "Téléchargement des fichiers",
            "mini_title": "Téléchargé",
            "mini_title_uploading": "Téléchargement",
            "show_completed": "Afficher terminé",
            "retry_failed": "Échec de la nouvelle tentative",
            "abort_all": "Abandonner tout",
            "upload_more": "Importer plus",
            "done": "Terminé",
            "mini_upload_count": "{{num}} importé(s)",
            "mini_failed": "{{num}} a échoué",
            "statuses": {
              "uploading": "Téléchargement en cours...",
              "error": "Erreur",
              "uploaded": "Terminé",
              "aborted": "abandonné"
            }
          },
        },
      },
    }, (error, result) => { 
        if (!error && result && result.event === "success") { 
          console.log(result);
          console.log('Done! Here is the image info: ', result.info);
          const media = document.querySelector("#media");
          media.value += (media.value ? "\\n" : "") + result.info.url;
          media.value.trim() !== "" && media.classList.add('is-valid');
          media.dispatchEvent(new Event("change"));
        } else if (!error && result && result.event === 'display-changed') {
          if (cloudinaryWidget.isShowing()){
            document.getElementById('cloudinaryWidget-close-btn').classList.toggle('d-none');
          } else {
            document.getElementById('cloudinaryWidget-close-btn').classList.toggle('d-none');
          };
        }
      }
    );

    document.getElementById("media").addEventListener("click", function(){
      cloudinaryWidget.open();
    }, false);

    const closeButtonHtmlString = `
      <div
        class="container-btn-cloudinary-widget-close d-none d-lg-none"
        id='cloudinaryWidget-close-btn'>
        <button class="btn btn-danger">
          Fermer
        </button>
      </div>
    `;
    const div = document.createElement('div');
    div.innerHTML = closeButtonHtmlString.trim();
    const closeButtonnNode = div.firstChild; 
    closeButtonnNode.addEventListener("click", () => {
      cloudinaryWidget.close();
    });
    const iframe = document.getElementsByTagName('iframe')[0];
    const parent = iframe.parentNode;
    parent.insertBefore(closeButtonnNode, iframe);
</script>  
  <script>
    const description = document.querySelector("#description");
    const sources = document.querySelector("#sources");
    const media = document.querySelector("#media");
    const email = document.querySelector("#email");
    const senderLocation = document.querySelector("#location");
    const fullName = document.querySelector("#fullName");

    const formData = {};

    for (let field of [
      description,
      sources,
      media,
      email,
      fullName,
      senderLocation,
    ]) {
      field.addEventListener("change", (e) => {
        const {
          target: { name, type, value, checked, files },
        } = e;
        if (field === email || field === fullName) {
          formData["author"] = {
            ...formData["author"],
            [name]: value,
          };
        } else if (field === senderLocation) {
          formData["location"] = value;
        } else if (field === sources || field === media) {
          formData[name] = value?.trim()?.split("\\n");
        } else {
          formData[name] = value;
        }
      });
    }

    const requestFactcheck = document.querySelector("#request_factcheck");
    requestFactcheck.addEventListener("submit", function (e) {
      e.preventDefault();
      const regexEmail = new RegExp(
        /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
      );
      if (
        !description.value.length ||
        !senderLocation.value.length ||
        (email.value.length && !regexEmail.test(email.value))
      ) {
        const err = document.querySelector("#err");
        err.innerHTML =
          "Le champ <b>description</b> et <b>emplacement</b> sont obligatoires et doivent être valides";
      } else {
        e.target.value = "Envoi des données...";
        axios
          .post("/api/news/", formData)
          .then((res) => {
            description.value = "";
            email.value = "";
            location.value = "";
            fullName.value = "";
            sources.value = "";
            media.value = "";
            e.target.value = "Envoyer";
            err.style.color = "white";
            err.style.backgroundColor = "#25e487";
            err.style.fontWeight = "bold";
            err.innerText = "Informations envoyées pour verification";
            err.style.fontSize = "1.5em";
            window.location.href = "http://localhost:5000/";
          })
          .catch((err) => console.log(err));
      }
    });
  </script>
</div>
